<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quizzatopia Community</title>
    <meta name="robots" content="nofollow">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"  crossorigin="anonymous">


  <script  defer src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.9.3/umd/popper.min.js"></script>

  <script  defer src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

	  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">
	  <script  defer src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.2/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="./style.css" />
  
    <link rel="import" href="./elements/navbar.html">
    <link rel="import" href="./elements/footer.html">
	  
	   <div id="navbar"></div>
  <!-- Firebase SDK -->
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script  src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Custom scripts -->
  <script  src="/main.js"></script> 
  	<style>
	

		.shadow {
			box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
		}
	</style>
	  
	    <style>
    .channel {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
    }

    .channel img {
      max-width: 200px;
      height: auto;
    }
  </style>
 </head>
<body>
  <!-- Header -->

 


  <!-- Main Content -->
  <main>
	  
    <!-- Channel Sidebar -->
    <aside class="channel-sidebar">
      <h2>Discussions</h2>
      <!-- Display a list of channels -->
      <ul>
<div id="channels-list"></div>
        <!-- Add more channels here -->
      </ul>
    </aside>
	  
	  
	  
  <div class="container">
	  
<!-- Toolbar -->
  <div class="toolbar">
    <button class="button" onclick="switchView('thread-listing-view')">Thread Listing</button>
    <button class="button" onclick="switchView('thread-details-view')">Thread Details</button>
  </div>

  <!-- View Container -->
  <div class="view-container">
    <!-- Thread Listing View -->
    <section id="thread-listing-view" class="view active">
      <h2>Main Discussion</h2>
	     <button class="start-discussion-button" onclick="openCreateThreadPopup()">Start Discussion</button>
      <ul id="thread-list"></ul>
    </section>

    <!-- Thread Details View -->
    <section id="thread-details-view" class="view">
      <button id="back-to-listing-button" class="button" onclick="switchView('thread-listing-view')">Back to Listing</button>
      <!-- Display thread details like author, date, content, replies, etc. -->
      <div id="thread-content">
      </div>
      <div class="replies">
	      <div id="reply-list"></div>
	      
        <!-- Display thread replies -->
        <div class="reply">
          <!-- Display individual reply content -->
        </div>
        <!-- Add more replies here -->
      </div>
    </section>
  </div>

	  
	  
	  
	  
	  
	  
	  <section id="reply-popup" class="create-thread-popup">
  <div class="create-thread-container">
    <button class="exit-button" onclick="closeReplyPopup()">X</button>
    <h2>Reply to Thread</h2>
    <form id="reply-form">
      <label for="reply-content">Reply Content:</label>
      <textarea id="reply-content" required></textarea>

      <button type="submit">Submit Reply</button>
    </form>
  </div>
</section>
	  
	  
	  
	  
	  
	  
	  
	  <!-- Create Thread Form -->
<section id="thread-popup" class="create-thread-popup">
  <div class="create-thread-container">
    <button class="exit-button" onclick="closeCreateThreadPopup()">X</button>
    <h2>Create a New Thread</h2>
    <form id="create-thread-form">
      <label for="thread-title">Thread Title:</label>
      <input type="text" id="thread-title" required>

      <label for="thread-content">Thread Content:</label>
<textarea id="thread-content" required="" spellcheck="false"></textarea>

      <button type="submit">Create Thread</button>
    </form>
  </div>
</section>

	  
	  
	  
  </div>


  </main>


  <!-- Include your JavaScript files here to integrate Firebase functionality -->
	
	<script>
				var channelID;
	var threadId = '';

function filterContent(content) {
	 if (content == null) {
    return ''; // Return an empty string if content is null or undefined
  }
  // Array of bad words
  const badWords = ['badword1', 'badword2', 'badword3'];

  // Regular expression for matching contact information
  const contactInfoRegex = /\b(?:\d{10}|\d{3}[-.\s]\d{3}[-.\s]\d{4}|(?:\+\d{1,2}\s?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4})\b/g;

  // Replace bad words with asterisks
  badWords.forEach((word) => {
    const regex = new RegExp(`\\b${word}\\b`, 'gi');
    content = content.replace(regex, '***');
  });

  // Replace contact information with asterisks
  content = content.replace(contactInfoRegex, '***');

// Remove HTML tags for additional safety
  const tempElement = document.createElement('div');
  tempElement.innerHTML = content;
  content = tempElement.textContent || tempElement.innerText;

  // Prevent script injection by removing JavaScript event handlers
  if (typeof content === 'string') {
    content = content.replace(/<[^>]+? on\w+="[^"]*"[^>]*>/gi, (match) => {
      return match.replace(/ on\w+="[^"]*"/gi, '');
    });
  }
  return content;
}
		
		
		
		
		
// JavaScript code
window.addEventListener('DOMContentLoaded', () => {
  const channelDiv = document.getElementById('channel-div');

  // Add "active" class to channel div on page load
  channelDiv.classList.add('active');

  // Add click event listener to channel div
  channelDiv.addEventListener('click', () => {
    // Remove "active" class from all channel divs
    const allChannelDivs = document.querySelectorAll('.channel-div');
    allChannelDivs.forEach((div) => {
      div.classList.remove('active');
    });

    // Add "active" class to the clicked channel div
    channelDiv.classList.add('active');
  });
});
		
		
function openCreateThreadPopup() {
	//slideIn(xxx)
  document.querySelector('#thread-popup').style.display = 'block';
}

function closeCreateThreadPopup() {
  document.querySelector('#thread-popup').style.display = 'none';
}	
		
		
		
// Modify switchView function
function switchView(viewId) {
  // Hide all views
  const views = document.querySelectorAll('.view');
  views.forEach((view) => {
    view.classList.remove('active');
  });

  // Show the selected view
  const selectedView = document.getElementById(viewId);
  selectedView.classList.add('active');
}

// Call switchView function with the welcome channel ID on page load
window.addEventListener('DOMContentLoaded', () => {
  const welcomeChannelId = 'Ac325oPGwa1stwy7Tu34'; // Replace with the actual welcome channel ID
  //switchView(welcomeChannelId);
});

		
		
function openReplyPopup(threadId) {
  document.querySelector('#reply-popup').style.display = 'block';
	threadId = threadId
}

function closeReplyPopup() {
  document.querySelector('#reply-popup').style.display = 'none';
}

// Add event listener for reply form submission
const replyForm = document.getElementById('reply-form');
replyForm.addEventListener('submit', (event) => {
  event.preventDefault(); // Prevent the default form submission

  // Get the value from the reply input field
  const replyContent = document.getElementById('reply-content').value;
  const filtered_replyContent = filterContent(replyContent);
  // Perform necessary actions (e.g., save to Firebase, update UI, etc.)
  addReply(filtered_replyContent);

  // Reset the form
  replyForm.reset();

  // Close the reply pop-up
  closeReplyPopup();
});
		
		
		
function formatTimestamp(timestamp) {
  // Convert the timestamp to a Date object
  const date = new Date(timestamp);

  // Format the date as desired (e.g., using toLocaleString, moment.js, or custom formatting)
  // ...

  // Return the formatted timestamp
  return date.toLocaleString(); // Example: using toLocaleString for formatting
}

		
		
		
		
		
		
		
		
		
		
		
		
		
		// Initialize Firebase
//firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


		// Retrieve the thread ID from the URL query parameter (replace 'threadId' with the actual parameter name)

		// Call the function to retrieve and display the thread details on page load
//const urlParams = new URLSearchParams(window.location.search);
//const threadId = urlParams.get('threadId');
/*		
if (threadId) {
  getThreadDetails(threadId);
  getReplies(threadId); // Pass threadId to getReplies function
} else {
  // Handle the case when threadId is not provided
  console.error('Thread ID not found in URL parameters');
}
*/

		
	
		
		
		
		
// Reference to the thread content and reply list elements
const threadContent = document.getElementById('thread-content');
const replyList = document.getElementById('reply-list');

// Function to retrieve the selected thread's details from Firebase
function getThreadDetails(threadId) {
  // Retrieve the thread document from Firebase using the thread ID
  firebase
    .firestore()
    .collection('threads')
    .doc(threadId)
    .get()
    .then((doc) => {
      if (doc.exists) {
        const threadData = doc.data();

        // Display the thread content
        threadContent.innerHTML = `
          <h3>${threadData.title}</h3>
          <div class="thread-details">
            <div class="thread-author">
              <p>Author: ${threadData.user}</p>
              <img src="${threadData.picture}" alt="Author Picture">
            </div>
            <div class="thread-info">
              <p>Timestamp: ${threadData.timestamp}</p>
              <p>Votes: ${threadData.votes}</p>
              <p>Points: ${threadData.points}</p>
              <p>Rank: ${threadData.rank}</p>
              <p>Quizzes Taken: ${threadData.quizzesTaken}</p>
            </div>
          </div>
          <p>${threadData.content}</p>
          <button id="reply-button" class="button" onclick="openReplyPopup('${threadId}')">Reply</button>
        `;
      } else {
        // Handle the case when the document does not exist
        console.log('Thread does not exist.');
      }
    })
    .catch((error) => {
      // Handle any errors that occurred during retrieval
      console.error('Error retrieving thread details:', error);
    });
}



// Function to retrieve and display the replies for the selected thread
// Function to retrieve and display the replies for the selected thread
function getReplies() {
  db.collection('replies')
    .where('threadId', '==', threadId)
    .orderBy('timestamp')
    .get()
    .then((querySnapshot) => {
      replyList.innerHTML = ''; // Clear existing replies

      querySnapshot.forEach((doc) => {
        const replyData = doc.data();

        // Create a div for each reply
        const replyDiv = document.createElement('div');
        replyDiv.classList.add('reply');

        // Set the reply content, author, timestamp, etc.
        replyDiv.innerHTML = `
          <p>Author: ${replyData.author}</p>
          <p>Timestamp: ${formatTimestamp(replyData.timestamp)}</p>
          <p>${replyData.content}</p>
          <!-- Additional reply information can be added here -->
          <!-- For replies -->
          <button class="vote-button" onclick="voteReply('up', '${doc.id}')">Upvote</button>
          <button class="vote-button" onclick="voteReply('down', '${doc.id}')">Downvote</button>
        `;

        replyList.appendChild(replyDiv);
      });
    })
    .catch((error) => {
      console.log("Error getting replies:", error);
    });
}



// Function to add a new reply to the thread
function addReply(content) {
  // Get the current user's information (replace with your authentication system)
     const userInfo = getUserInfo();


  // Create a new reply object
  const newReply = {
    user: userInfo.userName,
    id: userInfo.firebaseId,
    email: userInfo.userEmail,
    rank: userInfo.userRank,
    points: userInfo.userPoints,
    profilePic: userInfo.userProfilePic,
    quizzesTaken: userInfo.userQuizzesTaken,
    content: content,
    timestamp: new Date().toISOString(),
    threadId: threadId,
  };

  // Add the new reply to the 'replies' collection in Firestore
  db.collection('replies').add(newReply)
    .then((docRef) => {
      console.log("New reply added with ID: ", docRef.id);
    })
    .catch((error) => {
      console.error("Error adding reply: ", error);
    });
}


// Call the functions to retrieve and display the thread details and replies on page load
getThreadDetails();
getReplies();
		
		
		
		
		
		

		
// Reference to the thread list element
const threadList = document.getElementById('thread-list');

		
		
		
		
// Function to retrieve thread data from Firebase and populate the thread list
function populateThreadList(channelID) {
	channelID = channelID;
  // Retrieve thread data from Firestore and sort by vote count
  firebase.firestore().collection('threads').orderBy('votes', 'desc').get()
    .then((querySnapshot) => {
      threadList.innerHTML = ''; // Clear existing thread list

      querySnapshot.forEach((doc) => {
        const threadData = doc.data();

        // Create a list item for each thread
        const listItem = document.createElement('li');

        // Set the thread title, author, timestamp, vote count, etc.
    listItem.innerHTML = `
  <div class="thread-container">
    <h3>${threadData.title}</h3>
    <p>Author: ${threadData.user}</p>
    <p>Timestamp: ${threadData.timestamp}</p>
    <div class="vote-section">
      <div class="vote-count">Votes: ${threadData.votes}</div>
      <button class="vote-button" onclick="voteThread('up', '${doc.id}')">Upvote</button>
      <button class="vote-button" onclick="voteThread('down', '${doc.id}')">Downvote</button>
    </div>
    <div class="thread-details">
      <div class="author-info">
        <div class="author-picture">
          <img src="${threadData.picture}" alt="Thread Picture">
        </div>
        <div class="author-details">
          <p>Points: ${threadData.points}</p>
          <p>Rank: ${threadData.rank}</p>
          <p>Quizzes Taken: ${threadData.quizzesTaken}</p>
        </div>
      </div>
      <div class="view-details" onclick="switchView('thread-details-view'); getThreadDetails('${doc.id}')">View Details</div>
    </div>
  </div>
`;


        threadList.appendChild(listItem);
      });
    })
    .catch((error) => {
      console.log('Error getting threads:', error);
    });
}

// Call the function to populate the thread list on page load
populateThreadList();

		
		
		
		
		
		
	document.addEventListener('DOMContentLoaded', function() {
	
		
		
		// Get a reference to the form element
const createThreadForm = document.getElementById('create-thread-form');

// Add event listener for form submission
createThreadForm.addEventListener('submit', (event) => {
  event.preventDefault(); // Prevent the default form submission

  // Get the values from the form fields
  const threadTitle = document.getElementById('thread-title').value;
  const threadContent = document.getElementById('thread-content').value;

	console.log("threadContent        "+threadContent);
  const filtered_threadTitle = filterContent(threadTitle);
  const filtered_threadContent = filterContent(threadContent);
console.log("filtered_threadContent        "+filtered_threadContent);
	
  // Perform necessary actions (e.g., save to Firebase, update UI, etc.)
  createThread(channelID, filtered_threadTitle, filtered_threadContent);
	
	// Reset the form
 createThreadForm.reset();
});
		
		});
		
		

function createThread(channelId, title, content) {
  // Get a reference to the Firestore collection
  const threadsCollection = firebase.firestore().collection('threads');
  const userInfo = getUserInfo();

  // Create a new reply object
  const newReply = {
    user: userInfo.userName,
    id: userInfo.firebaseId,
    email: userInfo.userEmail,
    rank: userInfo.userRank,
    points: userInfo.userPoints,
    profilePic: userInfo.userProfilePic,
    quizzesTaken: userInfo.userQuizzesTaken,
    content: content,
    timestamp: new Date().toISOString(),
    threadId: threadId,
  };

// Create a new thread document
  threadsCollection
    .add({
      channelId: channelId, // Add the channel ID to the thread document
      title: title,
      content: content,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      author: userInfo.userName,
      votes: 0,
      category: 'general',
      // Add more properties as needed
    })
    .then((docRef) => {
      // Thread created successfully
      console.log('Thread created with ID:', docRef.id);
      // You can perform additional actions here, such as updating UI
    })
    .catch((error) => {
      // Handle any errors that occurred during thread creation
      console.error('Error creating thread:', error);
    });
}

// Call createThread function with the channel ID when creating a new thread
//createThread(channelId, threadTitle, threadContent);


// Function to vote on a thread
function voteThread(voteType, threadId) {
  // Get a reference to the thread document
  const threadRef = firebase.firestore().collection('threads').doc(threadId);
  // Get the authenticated user
  const user = firebase.auth().currentUser;

  if (user) {
    // Check if the user has already voted on this thread
    threadRef
      .collection('votes')
      .doc(user.uid)
      .get()
      .then((doc) => {
        if (doc.exists) {
          console.log('User has already voted on this thread.');
          // You can show an error message or prevent the user from voting again
        } else {
          // Update the vote count based on the vote type
          threadRef.update({
            votes: firebase.firestore.FieldValue.increment(voteType === 'up' ? 1 : -1)
          })
          .then(() => {
            console.log('Thread voted successfully.');
            // Update the UI if necessary
          })
          .catch((error) => {
            console.error('Error voting on thread:', error);
          });

          // Store the user's vote in the 'votes' subcollection
          threadRef
            .collection('votes')
            .doc(user.uid)
            .set({
              voteType: voteType
            })
            .then(() => {
              console.log('User vote stored successfully.');
              // Update the UI if necessary
            })
            .catch((error) => {
              console.error('Error storing user vote:', error);
            });
        }
      })
      .catch((error) => {
        console.error('Error checking user vote:', error);
      });
  } else {
    console.log('User is not authenticated. Voting is allowed only for authenticated users.');
    // You can show an error message or prompt the user to authenticate
  }
}

// Function to vote on a reply
function voteReply(voteType, replyId) {
  // Get a reference to the reply document
  const replyRef = firebase.firestore().collection('replies').doc(replyId);
  // Get the authenticated user
  const user = firebase.auth().currentUser;

  if (user) {
    // Check if the user has already voted on this reply
    replyRef
      .collection('votes')
      .doc(user.uid)
      .get()
      .then((doc) => {
        if (doc.exists) {
          console.log('User has already voted on this reply.');
          // You can show an error message or prevent the user from voting again
        } else {
          // Update the vote count based on the vote type
          replyRef.update({
            votes: firebase.firestore.FieldValue.increment(voteType === 'up' ? 1 : -1)
          })
          .then(() => {
            console.log('Reply voted successfully.');
            // Update the UI if necessary
          })
          .catch((error) => {
            console.error('Error voting on reply:', error);
          });

          // Store the user's vote in the 'votes' subcollection
          replyRef
            .collection('votes')
            .doc(user.uid)
            .set({
              voteType: voteType
            })
            .then(() => {
              console.log('User vote stored successfully.');
              // Update the UI if necessary
            })
            .catch((error) => {
              console.error('Error storing user vote:', error);
            });
        }
      })
      .catch((error) => {
        console.error('Error checking user vote:', error);
      });
  } else {
    console.log('User is not authenticated. Voting is allowed only for authenticated users.');
    // You can show an error message or prompt the user to authenticate
  }
}

		
		
	
// Function to create channels in HTML
function createChannelElement(channelData) {
  const channelElement = `
    <div id="ch${channelData.id}" class="channel channel-div"  onclick="switchView('thread-listing-view'); populateThreadList('${channelData.id}')">

      <h3>${channelData.name}</h3>
      <p>${channelData.description}</p>
      <img src="${channelData.picture}" alt="${channelData.name} Picture">
    </div>
  `;

  return channelElement;
}

// Function to get channels from Firestore and display them in HTML
function getChannels() {
  const channelsList = document.getElementById('channels-list');
	
		   // console.log("getChannels        ");

  // Get all the channels from the Firestore collection
  db.collectionGroup('channels').get()
    .then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        const channelData = doc.data();
	      
		//    console.log("channelData  n      "+channelData.name);
channelID = channelData.id;
	      		    //console.log("channelID        "+channelID);

        // Create HTML elements for each channel
        const channelElement = createChannelElement(channelData);

        // Add the channel element to the channels list
        channelsList.insertAdjacentHTML('beforeend', channelElement);
      });
    })
    .catch((error) => {
      console.error('Error getting channels:', error);
    });
}

// Call the getChannels function to retrieve and display the channels
getChannels();
		
	</script>
</body>
  <!-- Footer -->

</html>

